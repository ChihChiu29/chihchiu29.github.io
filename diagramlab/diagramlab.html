<head>
  <script src="base.js"></script>
  <script src="shape.js"></script>
  <script src="link.js"></script>
  <script src="layout.js"></script>
  <script src="diagramlang.js"></script>
</head>

<body>
  <style>
    text {
      font-family: sans-serif;
    }

    textarea {
      width: 100%;
      height: 50vh;
    }

    #canvas-save {
      width: 100%;
    }

    #report {
      background-color: yellow;
      position: fixed;
      bottom: 0;
      left: 0;
      padding-left: 5px;
      width: 100%;
    }
  </style>
  <div class="header">
    <h1>Welcome to the DiagramLab!</h1>
  </div>
  <p>
    DiagramLab lets you draw relation diagrams using a simple declarative language.
  </p>
  <p>
    Use the textarea below to type in the code for generating a diagram, then use the buttons
    to draw or save the diagram.
  </p>
  <p>
    Use the example and list of keywords as a quick start. Expanding the keyword line for detailed references.
  </p>
  <details>
    <summary>
      <b>Keywords:</b>
      <span id="reference"></span>
    </summary>
    <h3>Concept</h3>
    <div>
      All created objects are either "shape"s or as "link"s. Shapes are named, and they can be
      moved, stacked, set background color, etc. Links are unnamed, and must connect to existing shapes.
      When shapes are moved/resized, links will adjust automatically.
    </div>
    <h3>reference</h3>
    <div>
      <ul>
        <li>
          <p>Basic elements:</p>
          <ul>
            <li>
              Rect with multiline texts:
              <pre>rect [rect name] [multiline text (break line with "\n")]</pre>
            </li>
            <li>
              Rect with single line centered text:
              <pre>rectc [rect name] [single line text]</pre>
            </li>
            <li>
              Multiline texts:
              <pre>text [name] [multiline text (break line with "\n")]</pre>
            </li>
            <li>
              Create a straight link with text (use "-->" for dashed line):
              <pre>-> [from shape] [direction (up/down/left/right)] [to shape] [direction] [text along path]</pre>
            </li>
            <li>
              Create a Bezier curve (shape guessed from two end points) link with text (use "~~>" for dashed line):
              <pre>~> [from shape] [direction (up/down/left/right)] [to shape] [direction] [text along path]</pre>
            </li>
          </ul>
        </li>

        <li>
          <p>Common tranforms on shapes:</p>
          <ul>
            <li>
              Move and resize a shape (rect etc.):
              <pre>move [name] [left] [top] [width] [height]</pre>
            </li>
            <li>
              Change background color of a shape (rect etc.):
              <pre>bgcolor [shape name] [CSS color (single word)]</pre>
            </li>
          </ul>
        </li>

        <li>
          <p>Composited elements:</p>
          <ul>
            <li>
              Stack multiple shapes as children to a rect with a title:
              <pre>stack [name of the stack shape] [list of shapes to stack> with [title text]</pre>
            </li>
            <li>
              Tile multiple shapes as children for a new rect with a title:
              <pre>tile [name of the stack shape] [number of shapes per row] [list of shapes to stack] with [title text]</pre>
            </li>
          </ul>
        </li>

        <li>
          <p>Layout:</p>
          <ul>
            <li>
              Initialize a grid layout:
              <pre>grid [number of columns] [number of rows] [column gap] [row gap]</pre>
              The grid layout (contains number of columns) * (number of rows) cells, with specified gap between cells.
            </li>
            <li>
              Move and resize a shape using initialized grid layout:
              <pre>gridmove/gmove [name] [startColIdx] [startRowIdx] [endColIdx=startColIdx] [endRowIdx=startRowIdx]</pre>
              Move and resize the shape so that it spans the rectangular area covering the cells with specified start
              and end indices.
            </li>
            <li>
              Change viewport size:
              <pre>viewport [left] [top] [width] [height]</pre>
              If you uses grid layout, changing viewport invalidates it and you need to initialize it again.
            </li>
          </ul>
        </li>

        <li>
          <p>Miscellaneous:</p>
          <ul>
            <li>
              Variable/macro (use it with "$[name]"; contents will be blindly replaced):
              <pre>var [var name] [string values]</pre>
            </li>
            <li>
              Any line starts with "//" is treated as a comment.
            </li>
          </ul>
        </li>
      </ul>
  </details>
  </div>
  <textarea id="input" spellcheck="false"></textarea>
  <button onclick="draw()">DRAW</button>
  <button onclick="save()">SAVE AS PNG</button>
  <span id="report">
    <span id="location"></span>
    <span id="name"></span>
  </span>
  <div id="drawarea" style="border: solid"></div>
  <div id="save-action"></div>

  <script>
    function draw(useGrid = true) {
      const renderer = new SVGRenderer(document.querySelector('#drawarea'));
      renderer.useGrid = useGrid;
      const interpreter = new DiagramLangInterpreter(renderer);
      for (const cmd of document.querySelector('#input').value.split('\n')) {
        interpreter.handleSingleCommand(cmd);
      }
      interpreter.finish();
      renderer.draw();

      // Report mouse location when moving.
      const svgElement = document.querySelector('#drawarea svg');
      svgElement.removeEventListener('mousemove', reportLocationListener);
      svgElement.addEventListener('mousemove', reportLocationListener, false);

      // Report name of clicked named shape.
      // Ref: Fancy way to select elements with non empty attribute values: https://css-tricks.com/select-an-element-with-a-non-empty-attribute/
      // But here having a "name" attribute is enough.
      for (const elem of document.querySelectorAll('[name]')) {
        const nameElem = document.querySelector('#report #name');
        elem.addEventListener('mouseenter', (event) => {
          nameElem.innerText = `Element name: ${elem.getAttribute('name')}`;
        });
        elem.addEventListener('mouseleave', (event) => {
          nameElem.innerText = '';
        });
      }

      return renderer;
    }

    function save() {
      // References:
      //   - https://levelup.gitconnected.com/draw-an-svg-to-canvas-and-download-it-as-image-in-javascript-f7f7713cf81f
      //   - http://bl.ocks.org/biovisualize/8187844
      const renderer = draw(/*useGrid*/false);
      const svgElement = document.querySelector('#drawarea svg');

      const { width, height } = svgElement.getBBox();
      var svgString = new XMLSerializer().serializeToString(svgElement);
      blob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
      let URL = window.URL || window.webkitURL || window;
      let blobURL = URL.createObjectURL(blob);
      image = new Image();
      image.onload = () => {
        // Canvas references:
        //   - https://stackoverflow.com/questions/38061836/blurry-svg-in-canvas
        //   - https://stackoverflow.com/questions/24395076/canvas-generated-by-canvg-is-blurry-on-retina-screen
        let canvas = document.createElement('canvas');
        let context = canvas.getContext('2d');

        // In short:
        //   - devicePixelRatio decises how things are scaled on monitor.
        //   - to get a similar crisp feeling of the svg image, the canvas needs to be as large as viewport * scale factor.
        var pixelRatio = window.devicePixelRatio || 1;
        canvas.width = renderer.width;
        canvas.height = renderer.height;
        canvas.width *= pixelRatio;
        canvas.height *= pixelRatio;

        context.drawImage(image, 0, 0);
        let png = canvas.toDataURL();
        var link = document.createElement('a');
        link.download = 'diagram.png';
        link.style.opacity = "0";
        document.querySelector('#save-action').append(link);
        link.href = png;
        link.click();
        link.remove();
      };
      image.src = blobURL;
    }

    function reportLocationListener(evt) {
      const svgElement = document.querySelector('#drawarea svg');
      const pt = svgElement.createSVGPoint();
      pt.x = evt.clientX; pt.y = evt.clientY;
      const { x, y } = pt.matrixTransform(svgElement.getScreenCTM().inverse());
      document.querySelector('#report #location').innerText = `Coordinates: (${Math.floor(x)}, ${Math.floor(y)})`;
    }

    function onload() {
      document.querySelector('#input').value =
        `// set draw area
viewport 0 0 1200 1200

// simple examples
rect A1 hello world
rect A2 foo bar \\n text in new line
move A1 0 0 200 50
move A2 500 0 200 50
-> A1 right A2 left

// using composited shapes
rect B1 hello world
rect B2 foo bar
stack B_stacked B1 B2 with stacked!
rect B10 hello world
rect B11 foo bar
rect B12 whatever
tile B_tiled 1 B10 B11 B12 with tiled
move B_stacked 0 200 300 200
move B_tiled 800 200 300 200

// links! straight/curved: -/~, solid/dash: -/--, ~/~~, start/end/double arrow: </>/<*>
~> B2 right B12 left solid curved link with ending arrow
- B2 right B_tiled left solid straight link without arrow
<~~ A2 down B_stacked up dashed curved link
<--> A1 right B_tiled up dahsed straight link with double arrows
// manually create link annotation using text
text link_annotation manuallly added link annotation \\n blah blah blah
move link_annotation 450 370 300 30

// use grid layout
// 10x10 table, with 20 gap between columns and 20 gap between rows
grid 10 10 20 20
rect C1 single cell \\n rect
// move C1 to column 0 and row 6, it has the size of a single cell
gmove C1 0 6
rect C2 multi-cell \\n rect
// move C2 to column 5 and row 5, and makes it to span till column 6 and row 6
gmove C2 5 5 6 6
// links still work
~> C1 right C2 left
// finally, if you use stack or tile, (like normal rect) you need to gmove the stacked or tiled shape

// use variables
var commonsize 300 50
var common_y 1000
// now use $var to create new rects with same size
rect D1 new rect of same size and y 1
rect D2 new rect of same size and y 2
move D1 0 $common_y $commonsize
move D2 500 $common_y $commonsize

// change background color
var common_y_and_size 1100 300 50
rect E1 color: "lightblue"
rect E2 color: "pink"
rect E3 color: "#7d4a91"
move E1 0 $common_y_and_size
bgcolor E1 lightblue
move E2 400 $common_y_and_size
bgcolor E2 pink
move E3 800 $common_y_and_size
bgcolor E3 #7d4a91`;

      const interpreter = new DiagramLangInterpreter(document.querySelector('#drawarea'));
      document.querySelector('#reference').innerText = Object.keys(interpreter.handlerMap).join(', ');
    }

    document.addEventListener("DOMContentLoaded", onload);
  </script>

</body>