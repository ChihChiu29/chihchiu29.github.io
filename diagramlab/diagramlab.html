<head>
  <script src="/diagramlab/base.js"></script>
  <script src="/diagramlab/shape.js"></script>
  <script src="/diagramlab/link.js"></script>
  <script src="/diagramlab/layout.js"></script>
  <script src="/diagramlab/diagramlang.js"></script>
</head>

<body>
  <style>
    text {
      font-family: sans-serif;
    }

    textarea {
      width: 100%;
      height: 50vh;
    }

    #canvas-save {
      width: 100%;
    }
  </style>
  <h2>Welcome to the DiagramLab!</h2>
  <div>
    <details>
      <summary>
        <b>Supported commands:</b>
        <span id="reference"></span>
      </summary>
      <p>Details:</p>
      <ul>
        <li>
          <p>Common elements:</p>
          <ul>
            <li>
              Rect with multiline texts:
              <pre>rect [rect name] [multiline text (break line with "\n")]</pre>
            </li>
            <li>
              Rect with single line centered text:
              <pre>rectc [rect name] [single line text]</pre>
            </li>
            <li>
              Create a straight link with text (use "-->" for dashed line):
              <pre>-> [from shape] [direction (up/down/left/right)] [to shape] [direction] [text along path]</pre>
            </li>
            <li>
              Create a Bezier curve (shape guessed from two end points) link with text (use "~~>" for dashed line):
              <pre>~> [from shape] [direction (up/down/left/right)] [to shape] [direction] [text along path]</pre>
            </li>
          </ul>
        </li>

        <li>
          <p>Common tranforms on shapes:</p>
          <ul>
            <li>
              Move and resize a shape (rect etc.):
              <pre>move [name] [left] [top] [width] [height]</pre>
            </li>
            <li>
              Change background color of a shape (rect etc.):
              <pre>bgcolor [shape name] [CSS color (single word)]</pre>
            </li>
          </ul>
        </li>

        <li>
          <p>Composited elements:</p>
          <ul>
            <li>
              Stack multiple shapes as children to a rect with a title:
              <pre>stack [name of the stack shape] [list of shapes to stack> with [title text]</pre>
            </li>
            <li>
              Tile multiple shapes as children for a new rect with a title:
              <pre>tile [name of the stack shape] [number of shapes per row] [list of shapes to stack] with [title text]</pre>
            </li>
          </ul>
        </li>

        <li>
          <p>Layout:</p>
          <ul>
            <li>
              Initialize a grid layout:
              <pre>grid [number of columns] [number of rows] [column gap] [row gap]</pre>
              The grid layout (contains number of columns) * (number of rows) cells, with specified gap between cells.
            </li>
            <li>
              Move and resize a shape using initialized grid layout:
              <pre>gridmove/gmove [name] [startColIdx] [startRowIdx] [endColIdx=startColIdx] [endRowIdx=startRowIdx]</pre>
              Move and resize the shape so that it spans the rectangular area covering the cells with specified start
              and end indices.
            </li>
            <li>
              Change viewport size:
              <pre>viewport [left] [top] [width] [height]</pre>
              If you uses grid layout, changing viewport invalidates it and you need to initialize it again.
            </li>
          </ul>
        </li>

        <li>
          <p>Miscellaneous:</p>
          <ul>
            <li>
              Variable/macro (use it with "$[name]"; contents will be blindly replaced):
              <pre>var [var name] [string values]</pre>
            </li>
            <li>
              Any line starts with "//" is treated as a comment.
            </li>
          </ul>
        </li>
      </ul>
    </details>
  </div>
  <textarea id="input" spellcheck="false"></textarea>
  <button onclick="draw()">DRAW</button>
  <button onclick="save()">SAVE AS PNG</button>
  <div id="drawarea" style="border: solid"></div>
  <div id="save-action"></div>

  <script>
    function draw(useGrid = true) {
      const renderer = new SVGRenderer(document.querySelector('#drawarea'));
      renderer.useGrid = useGrid;
      const interpreter = new DiagramLangInterpreter(renderer);
      for (const cmd of document.querySelector('#input').value.split('\n')) {
        interpreter.handleSingleCommand(cmd);
      }
      interpreter.finish();
      renderer.draw();
      return renderer;
    }

    function save() {
      // References:
      //   - https://levelup.gitconnected.com/draw-an-svg-to-canvas-and-download-it-as-image-in-javascript-f7f7713cf81f
      //   - http://bl.ocks.org/biovisualize/8187844
      const renderer = draw(/*useGrid*/false);
      const svgElement = document.querySelector('#drawarea svg');

      const { width, height } = svgElement.getBBox();
      var svgString = new XMLSerializer().serializeToString(svgElement);
      blob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
      let URL = window.URL || window.webkitURL || window;
      let blobURL = URL.createObjectURL(blob);
      image = new Image();
      image.onload = () => {
        // Canvas references:
        //   - https://stackoverflow.com/questions/38061836/blurry-svg-in-canvas
        //   - https://stackoverflow.com/questions/24395076/canvas-generated-by-canvg-is-blurry-on-retina-screen
        let canvas = document.createElement('canvas');
        let context = canvas.getContext('2d');

        // In short:
        //   - devicePixelRatio decises how things are scaled on monitor.
        //   - to get a similar crisp feeling of the svg image, the canvas needs to be as large as viewport * scale factor.
        var pixelRatio = window.devicePixelRatio || 1;
        canvas.width = renderer.width;
        canvas.height = renderer.height;
        canvas.width *= pixelRatio;
        canvas.height *= pixelRatio;

        context.drawImage(image, 0, 0);
        let png = canvas.toDataURL();
        var link = document.createElement('a');
        link.download = 'diagram.png';
        link.style.opacity = "0";
        document.querySelector('#save-action').append(link);
        link.href = png;
        link.click();
        link.remove();
      };
      image.src = blobURL;
    }

    function onload() {
      document.querySelector('#input').value = `
// set draw area
viewport 0 0 1200 2000

// simple examples
rect A1 hello world
rect A2 foo bar \\n text in new line
move A1 0 0 200 50
move A2 500 0 200 50
-> A1 right A2 left

// using composited shapes
rect B1 hello world
rect B2 foo bar
stack B_stacked B1 B2 with stacked!
rect B10 hello world
rect B11 foo bar
rect B12 whatever
tile B_tiled 1 B10 B11 B12 with tiled
move B_stacked 0 200 300 200
move B_tiled 800 200 300 200

// arrows!
~> B2 right B12 left 
-> B2 right B_tiled left
~~> A2 down B_stacked up dashed curved link
--> A1 right B_tiled up dahsed straight link
`;


      // var bigsize 400 250
      // bgcolor A lightblue
      // stack X A B with stacked!
      // move X 30 30 $bigsize
      // rect C hello world
      // rect D foo bar
      // tile Y 3 C D with tiled!
      // move Y 130 450 $bigsize
      // ~> X down Y up
      // rect aa some right side box
      // move aa 500 50 $bigsize
      // -> X right aa left`;

      const interpreter = new DiagramLangInterpreter(document.querySelector('#drawarea'));
      document.querySelector('#reference').innerText = Object.keys(interpreter.handlerMap).join(', ');
    }

    document.addEventListener("DOMContentLoaded", onload);
  </script>

</body>