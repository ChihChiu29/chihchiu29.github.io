<!DOCTYPE html>
<html>

<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script type="text/javascript">

// A square with ~1250 feet each side.
const latitude_delta = 0.0019;
const longitude_delta = 0.0024;
// Used to enlarge the search area.
var distance_factor = 1.0;

function getLocation() {
  navigator.geolocation.getCurrentPosition(onHavingLocation);
}

function onHavingLocation(position) {
  distance_factor = $('#factor-input').val();

  from_latitude = position.coords.latitude - latitude_delta * distance_factor;
  to_latitude = position.coords.latitude + latitude_delta * distance_factor;
  from_longitude = position.coords.longitude - longitude_delta * distance_factor;
  to_longitude = position.coords.longitude + longitude_delta * distance_factor;

  query_header = 'https://moto.data.socrata.com/resource/wrmr-tdyp.json?$where=';
  param = "(`latitude` > "+ from_latitude + " AND `latitude` < " + to_latitude + " AND `longitude` > " + from_longitude + "AND `longitude` < " + to_longitude + " AND (`parent_incident_type` = 'Theft' OR `parent_incident_type` = 'Property Crime' OR `parent_incident_type` = 'Weapons Offense' OR `parent_incident_type` = 'Assault with Deadly Weapon' OR `parent_incident_type` = 'Breaking & Entering' OR `parent_incident_type` = 'Theft of Vehicle'))";
  query = query_header + escape(param);
  // Example search_results:
  // [{"incident_id":"834060383","case_number":"S180400222","incident_datetime":"2018-02-09T13:41:41.000","incident_type_primary":"BURGLARY (460)","incident_description":"Call Type: 459    <br>Description: BURGLARY (460)<br>Final Disposition: R","clearance_type":"","address_1":"16300 Block LAVENDER LN","city":"SANTA CLARA COUNTY","state":"CA","latitude":"37.238507967223796","longitude":"-121.95510804279245","created_at":"2018-02-12T21:37:35.000","updated_at":"2018-02-16T18:03:16.000","location":{"type":"Point","coordinates":[-121.955108042792,37.2385079672238]},"hour_of_day":"13","day_of_week":"Friday","parent_incident_type":"Breaking & Entering"},]
  $.get(query).done(function(search_results) {
    $('#result').text('Found ' + search_results.length + ' events.');
    var text = '';
    for (const e of search_results) {
      text += 'date and time: ' + e.incident_datetime + '<br/>';
      text += 'day_of_week: ' + e.day_of_week + '<br/>';
      text += 'type: ' + e.incident_type_primary + '<br/>';
      text += 'address: ' + e.address_1 + '<br/>';
      text += '<hr/>';
    }
    $('#info').text(text);
  });
}
</script>
<style>
.big {
  font-size: 24px;
}
</style>
</head>

<body>

<div class="big">
<div id="result">Click search to start</div><br/>
Search events within a square of side length
<input type="number" id="factor-input" value="1" min="1" max="100">
* 1250 feet.<br/>
<button onclick="getLocation()">Search / Refresh</button>
</div>

<div id="info"></div>

</body>

</html>