<!DOCTYPE html>
<html>
  <head>
    <title>Tracer</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 100%;
      }
    </style>
    <script src="firebase.js"></script>
    <script src="utils.js"></script>
    <script src="jquery-1.js"></script>
  </head>
  <body>
    <div id='inputDiv'>
        <input type='text' id='nameInput' placeholder='Put your name here'>
        <button onclick='setName()'>Set Name</button>
    </div>
    <div id="map"></div>
    <script>
        map = null;
        name = 'unknown';
        markers = [];
        
        registerFirebase('map-tracer');
        
        function setName() {
            name = $('#nameInput').val();
        }
        
        function initMap() {
          map = new google.maps.Map(document.getElementById('map'), {
            center: {lat: 37.3005705, lng: -121.77214839999999},
            zoom: 12
          });
          // Try HTML5 geolocation.
          if (navigator.geolocation) {
              updateCurrentLocation();
//            navigator.geolocation.getCurrentPosition(function(position) {
//              var pos = {
//                lat: position.coords.latitude,
//                lng: position.coords.longitude
//              };
//              map.setCenter(pos);
//            }, function() {
//              handleLocationError(true, infoWindow, map.getCenter());
//            });
          } else {
            // Browser doesn't support Geolocation
            handleLocationError(false, infoWindow, map.getCenter());
          }
        }

        function handleLocationError(browserHasGeolocation, infoWindow, pos) {
            var infoWindow = new google.maps.InfoWindow({map: map});
            infoWindow.setPosition(pos);
            infoWindow.setContent(browserHasGeolocation ?
                                'Error: The Geolocation service failed.' :
                                'Error: Your browser doesn\'t support geolocation.');
        }
        
        function drawMarker(name, latLng) {
            var marker = new google.maps.Marker({
                position: latLng,
                map: map,
                title: name
            });
            markers.push(marker);
        }
        
        myDataRef.on('value', function(dataSnapshot) {
            while(markers.length){
                markers.pop().setMap(null);
            }
            var positionData = dataSnapshot.val();
            for (name in positionData) {
                drawMarker(name, positionData[name]);
            }
            console.log('re-drawed!');
        });
        
        function updateCurrentLocation() {
            navigator.geolocation.getCurrentPosition(function(position) {
                var pos = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                map.setCenter(pos);
                updateLocation(name, pos);
                console.log('postion updated');
            }, function(error) {
                console.log(error);
            }, {
                enableHighAccuracy: true,
                timeout : 5000
            });
        }

    setInterval(updateCurrentLocation, 5000);
    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB67WaKH62UeuqBV9rV8tQgK7Cwy_bnx5o&callback=initMap">
    </script>
  </body>
</html>